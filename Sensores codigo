#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>

#include "DFRobot_EnvironmentalSensor.h"
#include "DFRobot_AirQualitySensor.h"
#include "SparkFun_Weather_Meter_Kit_Arduino_Library.h"

// -------------------- CONFIGURACIÓN OLED --------------------
#define SCREEN_WIDTH 128
#define SCREEN_HEIGHT 64
#define OLED_ADDR 0x3C
Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, -1);

// -------------------- PINES ESP32 --------------------
#define SDA_PIN 21
#define SCL_PIN 22
int windDirectionPin = 35; // Analógico
int windSpeedPin     = 14; // Digital (interrupción)
int rainfallPin      = 15; // Digital (ADC)

// -------------------- INSTANCIAS DE SENSORES --------------------
DFRobot_EnvironmentalSensor environment(SEN050X_DEFAULT_DEVICE_ADDRESS, &Wire);
#define SEN0460_ADDR 0x19
DFRobot_AirQualitySensor particle(&Wire, SEN0460_ADDR);
SFEWeatherMeterKit weatherMeterKit(windDirectionPin, windSpeedPin, rainfallPin);

// -------------------- SETUP --------------------
void setup() {
  Serial.begin(115200);
  Wire.begin(SDA_PIN, SCL_PIN);

  // --- Inicializar OLED ---
  if (!display.begin(SSD1306_SWITCHCAPVCC, OLED_ADDR)) {
    Serial.println(F("❌ Error al inicializar OLED"));
    for (;;);
  }
  display.clearDisplay();
  display.setTextSize(1);
  display.setTextColor(SSD1306_WHITE);
  display.setCursor(0, 0);
  display.println("Iniciando sensores...");
  display.display();

  // --- Inicializar SEN0501 ---
  while (environment.begin() != 0) {
    Serial.println("❌ SEN0501 no detectado...");
    delay(1000);
  }
  Serial.println("✅ SEN0501 inicializado");

  // --- Inicializar SEN0460 ---
  while (!particle.begin()) {
    Serial.println("❌ SEN0460 no detectado...");
    delay(1000);
  }
  Serial.println("✅ SEN0460 inicializado");

  uint8_t version = particle.gainVersion();
  Serial.print("Versión SEN0460: ");
  Serial.println(version);

  // --- Inicializar Weather Meter Kit ---
  weatherMeterKit.setADCResolutionBits(12); // ADC del ESP32
  weatherMeterKit.begin();

  Serial.println("✅ Weather Meter Kit listo");
  display.clearDisplay();
  display.setCursor(0, 0);
  display.println("Todos los sensores OK!");
  display.display();
  delay(1500);
}

// -------------------- LOOP PRINCIPAL --------------------
void loop() {
  // ==================== LECTURA SEN0501 ====================
  float tempC = environment.getTemperature(TEMP_C);
  float hum   = environment.getHumidity();
  float uv    = environment.getUltravioletIntensity();
  float lux   = environment.getLuminousIntensity();
  float press = environment.getAtmospherePressure(HPA);
  if (uv < 0) uv = 0;

  Serial.println("===== SEN0501 =====");
  Serial.printf("Temp: %.2f °C | Hum: %.2f %% | UV: %.2f mW/cm2 | Luz: %.2f lx | Presión: %.2f hPa\n",
                tempC, hum, uv, lux, press);

  // ==================== LECTURA SEN0460 ====================
  uint16_t PM1_0 = particle.gainParticleConcentration_ugm3(PARTICLE_PM1_0_ATMOSPHERE);
  uint16_t PM2_5 = particle.gainParticleConcentration_ugm3(PARTICLE_PM2_5_ATMOSPHERE);
  uint16_t PM10  = particle.gainParticleConcentration_ugm3(PARTICLE_PM10_ATMOSPHERE);

  Serial.println("===== SEN0460 =====");
  Serial.printf("PM1.0: %u | PM2.5: %u | PM10: %u ug/m³\n", PM1_0, PM2_5, PM10);

  // ==================== LECTURA WEATHER METER ====================
  float windDir = weatherMeterKit.getWindDirection();
  float windSpd = weatherMeterKit.getWindSpeed();
  float rainfall = weatherMeterKit.getTotalRainfall();

  Serial.println("===== WEATHER METER =====");
  Serial.printf("Dirección: %.1f° | Velocidad: %.2f kph | Lluvia total: %.2f mm\n",
                windDir, windSpd, rainfall);
  Serial.println("--------------------------------\n");

  // ==================== MOSTRAR EN OLED ====================
  display.clearDisplay();
  display.setCursor(0, 0);
  display.setTextSize(1);
  display.println("Estacion Meteorologica");
  display.print("T: "); display.print(tempC, 1); display.println("C");
  display.print("H: "); display.print(hum, 1); display.println("%");
  display.print("Vv: "); display.print(windSpd, 1); display.println("kph");
  display.print("Dir: "); display.print(windDir, 0); display.println("°");
  display.print("PM2.5: "); display.print(PM2_5); display.println(" ug/m3");
  display.print("Lluvia: "); display.print(rainfall, 1); display.println(" mm");
  display.display();

  delay(2000);
}
